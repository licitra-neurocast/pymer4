<!DOCTYPE html>
<html >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>pymer4.models</title>
    
      <link rel="stylesheet" href="../../_static/pygments.css">
      <link rel="stylesheet" href="../../_static/theme.css">
      
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>

      <!-- sphinx script_files -->
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

      
      <script src="../../_static/theme-vendors.js"></script>
      <script src="../../_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="../../genindex.html" />
  <link rel="search" title="Search" href="../../search.html" /> 
  </head>

  <body><div id="app" class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../../index.html" class="home-link">
    
      <span class="site-name">pymer4</span>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">

  
    <div class="nav-item">
      <a href="../../index.html#basic-usage-guide"
         class="nav-link ">
         Pymer4
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../index.html#categorical-predictors"
         class="nav-link ">
         Pymer4
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../index.html#post-hoc-comparisons"
         class="nav-link ">
         Pymer4
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../index.html#simulating-data"
         class="nav-link ">
         Pymer4
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../index.html#lme4-cheatsheet"
         class="nav-link ">
         Pymer4
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../index.html#api"
         class="nav-link ">
         Pymer4
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../test.html#test"
         class="nav-link ">
         Test
      </a>
    </div>
  



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            

  
    <div class="nav-item">
      <a href="../../index.html#basic-usage-guide"
         class="nav-link ">
         Pymer4
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../index.html#categorical-predictors"
         class="nav-link ">
         Pymer4
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../index.html#post-hoc-comparisons"
         class="nav-link ">
         Pymer4
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../index.html#simulating-data"
         class="nav-link ">
         Pymer4
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../index.html#lme4-cheatsheet"
         class="nav-link ">
         Pymer4
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../index.html#api"
         class="nav-link ">
         Pymer4
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../test.html#test"
         class="nav-link ">
         Test
      </a>
    </div>
  



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="../../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../index.html#basic-usage-guide">Pymer4</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 "><a href="../../usage.html" class="reference internal ">Basic Usage Guide</a>

            
          </li>

        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../index.html#categorical-predictors">Pymer4</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 "><a href="../../categorical.html" class="reference internal ">Categorical Predictors</a>

            
          </li>

        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../index.html#post-hoc-comparisons">Pymer4</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 "><a href="../../post_hoc.html" class="reference internal ">ANOVA tables and post-hoc comparisons</a>

            
          </li>

        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../index.html#simulating-data">Pymer4</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 "><a href="../../simulate.html" class="reference internal ">Simulating Data</a>

            
          </li>

        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../index.html#lme4-cheatsheet">Pymer4</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 "><a href="../../rfx_cheatsheet.html" class="reference internal ">Lme4 Random Effects Cheat Sheet</a>

            
          </li>

        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../index.html#api">Pymer4</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 "><a href="../../api.html" class="reference internal ">API Reference</a>

            
          </li>

        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../test.html#test">Test</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 "><a href="../../test2.html" class="reference internal ">Title1</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="../../test2.html" class="reference internal ">Title1</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="../../api.html" class="reference internal ">API</a>

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
    
      <li><a href="../index.html">Module code</a> &raquo;</li>
    
    <li>pymer4.models</li>
  </ul>
  

  <ul class="page-nav">
</ul>
  
</div>
<hr>
          <div class="content" role="main">
            
  <h1>Source code for pymer4.models</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">rpy2.robjects</span> <span class="k">as</span> <span class="nn">robjects</span>
<span class="kn">from</span> <span class="nn">rpy2.robjects.packages</span> <span class="k">import</span> <span class="n">importr</span>
<span class="kn">from</span> <span class="nn">rpy2.robjects</span> <span class="k">import</span> <span class="n">pandas2ri</span>
<span class="kn">import</span> <span class="nn">rpy2</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">t</span> <span class="k">as</span> <span class="n">t_dist</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">patsy</span> <span class="k">import</span> <span class="n">dmatrices</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="k">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">from</span> <span class="nn">pymer4.stats</span> <span class="k">import</span> <span class="n">_welch_ingredients</span>
<span class="kn">from</span> <span class="nn">pymer4.utils</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">_sig_stars</span><span class="p">,</span>
    <span class="n">_chunk_boot_ols_coefs</span><span class="p">,</span>
    <span class="n">_chunk_perm_ols</span><span class="p">,</span>
    <span class="n">_permute_sign</span><span class="p">,</span>
    <span class="n">_ols</span><span class="p">,</span>
    <span class="n">_ols_group</span><span class="p">,</span>
    <span class="n">_corr_group</span><span class="p">,</span>
    <span class="n">_perm_find</span><span class="p">,</span>
    <span class="n">_return_t</span><span class="p">,</span>
    <span class="n">to_ranks_by_group</span><span class="p">,</span>
    <span class="n">rsquared</span><span class="p">,</span>
    <span class="n">rsquared_adj</span>
<span class="p">)</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Eshin Jolly&quot;</span><span class="p">]</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;MIT&quot;</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;always&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>
<span class="n">pandas2ri</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>


<div class="viewcode-block" id="Lmer"><a class="viewcode-back" href="../../api.html#pymer4.models.Lmer">[docs]</a><span class="k">class</span> <span class="nc">Lmer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model class to hold data outputted from fitting lmer in R and converting to Python object. This class stores as much information as it can about a merMod object computed using lmer and lmerTest in R. Most attributes will not be computed until the fit method is called.</span>

<span class="sd">    Args:</span>
<span class="sd">        formula (str): Complete lmer-style model formula</span>
<span class="sd">        data (pandas.core.frame.DataFrame): input data</span>
<span class="sd">        family (string): what distribution family (i.e.) link function to use for the generalized model; default is gaussian (linear model)</span>

<span class="sd">    Attributes:</span>
<span class="sd">        fitted (bool): whether model has been fit</span>
<span class="sd">        formula (str): model formula</span>
<span class="sd">        data (pandas.core.frame.DataFrame): model copy of input data</span>
<span class="sd">        grps (dict): groups and number of observations per groups recognized by lmer</span>
<span class="sd">        AIC (float): model akaike information criterion</span>
<span class="sd">        logLike (float): model Log-likelihood</span>
<span class="sd">        family (string): model family</span>
<span class="sd">        ranef (pandas.core.frame.DataFrame/list): cluster-level differences from population parameters, i.e. difference between coefs and fixefs; returns list if multiple cluster variables are used to specify random effects (e.g. subjects and items)</span>
<span class="sd">        fixef (pandas.core.frame.DataFrame/list): cluster-level parameters; returns list if multiple cluster variables are used to specify random effects (e.g. subjects and items)</span>
<span class="sd">        coefs (pandas.core.frame.DataFrame/list): model summary table of population parameters</span>
<span class="sd">        resid (numpy.ndarray): model residuals</span>
<span class="sd">        fits (numpy.ndarray): model fits/predictions</span>
<span class="sd">        model_obj(lmer model): rpy2 lmer model object</span>
<span class="sd">        factors (dict): factors used to fit the model if any</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">family</span>
        <span class="n">implemented_fams</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;gaussian&quot;</span><span class="p">,</span>
            <span class="s2">&quot;binomial&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gamma&quot;</span><span class="p">,</span>
            <span class="s2">&quot;inverse_gaussian&quot;</span><span class="p">,</span>
            <span class="s2">&quot;poisson&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">implemented_fams</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Family must be one of: gaussian, binomial, gamma, inverse_gaussian or poisson!&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AIC</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logLike</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranef_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranef_corr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranef</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranked_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factors_prev_</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">(fitted = </span><span class="si">{}</span><span class="s2">, formula = </span><span class="si">{}</span><span class="s2">, family = </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_make_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor_dict</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Covert specific columns to R-style factors. Default scheme is dummy coding where reference is 1st level provided. Alternative is orthogonal polynomial contrasts. User can also specific custom contrasts.</span>

<span class="sd">        Args:</span>
<span class="sd">            factor_dict: (dict) dictionary with column names specified as keys, and lists of unique values to treat as factor levels</span>
<span class="sd">            ordered: (bool) whether to interpret factor_dict values as dummy-coded (1st list item is reference level) or as polynomial contrasts (linear contrast specified by ordered of list items)</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.core.frame.DataFrame: copy of original data with factorized columns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ordered</span><span class="p">:</span>
            <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                function(df,f,lv){</span>
<span class="s2">                df[,f] &lt;- factor(df[,f],lv,ordered=T)</span>
<span class="s2">                df</span>
<span class="s2">                }</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                function(df,f,lv){</span>
<span class="s2">                df[,f] &lt;- factor(df[,f],lv,ordered=F)</span>
<span class="s2">                df</span>
<span class="s2">                }</span>
<span class="s2">            &quot;&quot;&quot;</span>

        <span class="n">c_rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            function(df,f,c){</span>
<span class="s2">            contrasts(df[,f]) &lt;- c(c)</span>
<span class="s2">            df</span>
<span class="s2">            }</span>
<span class="s2">            &quot;&quot;&quot;</span>

        <span class="n">factorize</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="n">contrastize</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">c_rstring</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">factor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="n">r_df</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">py2ri</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">factor_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">r_df</span> <span class="o">=</span> <span class="n">factorize</span><span class="p">(</span><span class="n">r_df</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">levels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">contrasts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="n">r_df</span> <span class="o">=</span> <span class="n">factorize</span><span class="p">(</span><span class="n">r_df</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">levels</span><span class="p">)</span>
                <span class="n">r_df</span> <span class="o">=</span> <span class="n">contrastize</span><span class="p">(</span><span class="n">r_df</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">contrasts</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r_df</span>

    <span class="k">def</span> <span class="nf">_refit_orthogonal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Refit a model with factors organized as polynomial contrasts to ensure valid type-3 SS calculations with using `.anova()`. Previous factor specifications are stored in `model.factors_prev_`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">factors_prev_</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">)</span>
        <span class="c1"># Create orthogonal polynomial contrasts by just sorted factor levels alphabetically and letting R enumerate the required polynomial contrasts</span>
        <span class="n">new_factors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">new_factors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">factors</span><span class="o">=</span><span class="n">new_factors</span><span class="p">,</span>
            <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">summarize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">permute</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_permute</span><span class="p">,</span>
            <span class="n">conf_int</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_conf_int</span><span class="p">,</span>
            <span class="n">REML</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_REML</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Lmer.anova"><a class="viewcode-back" href="../../api.html#pymer4.models.Lmer.anova">[docs]</a>    <span class="k">def</span> <span class="nf">anova</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_orthogonal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a type-3 ANOVA table from a fitted model. Like R, this method does not ensure that contrasts are orthogonal to ensure correct type-3 SS computation. However, the force_orthogonal flag can refit the regression model with orthogonal polynomial contrasts automatically guaranteeing valid SS type 3 inferences. Note that this will overwrite factors specified in the last call to `.fit()`</span>

<span class="sd">        Args:</span>
<span class="sd">            force_orthogonal (bool): whether factors in the model should be recoded using polynomial contrasts to ensure valid type-3 SS calculations. If set to True, previous factor specifications will be saved in `model.factors_prev_`; default False</span>

<span class="sd">        Returns:</span>
<span class="sd">            anova_results (pd.DataFrame): Type 3 ANOVA results</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
            <span class="c1"># Model can only have factors if it&#39;s been fit</span>
            <span class="k">if</span> <span class="n">force_orthogonal</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_refit_orthogonal</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fit before ANOVA table can be generated!&quot;</span><span class="p">)</span>

        <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            function(model){</span>
<span class="s2">            df&lt;- anova(model)</span>
<span class="s2">            df</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">anova</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anova_results</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">anova</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anova_results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anova_results</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;SS&quot;</span><span class="p">,</span>
                <span class="s2">&quot;MS&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NumDF&quot;</span><span class="p">,</span>
                <span class="s2">&quot;DenomDF&quot;</span><span class="p">,</span>
                <span class="s2">&quot;F-stat&quot;</span><span class="p">,</span>
                <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anova_results</span><span class="p">[</span><span class="s2">&quot;Sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anova_results</span><span class="p">[</span><span class="s2">&quot;P-val&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_sig_stars</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">anova_results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;MODELING FIT WARNING! Check model.warnings!! P-value computation did not occur because lmerTest choked. Possible issue(s): ranefx have too many parameters or too little variance...&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anova_results</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DF&quot;</span><span class="p">,</span> <span class="s2">&quot;SS&quot;</span><span class="p">,</span> <span class="s2">&quot;MS&quot;</span><span class="p">,</span> <span class="s2">&quot;F-stat&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">force_orthogonal</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;SS Type III Analysis of Variance Table with Satterthwaite approximated degrees of freedom:</span><span class="se">\n</span><span class="s2">(NOTE: Model refit with orthogonal polynomial contrasts)&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;SS Type III Analysis of Variance Table with Satterthwaite approximated degrees of freedom:</span><span class="se">\n</span><span class="s2">(NOTE: Using original model contrasts, orthogonality not guaranteed)&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">anova_results</span></div>

<div class="viewcode-block" id="Lmer.fit"><a class="viewcode-back" href="../../api.html#pymer4.models.Lmer.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">conf_int</span><span class="o">=</span><span class="s2">&quot;Wald&quot;</span><span class="p">,</span>
        <span class="n">n_boot</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">factors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">permute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">summarize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">REML</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">rank</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">rank_group</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">rank_exclude_cols</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">no_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main method for fitting model object. Will modify the model&#39;s data attribute to add columns for residuals and fits for convenience.</span>

<span class="sd">        Args:</span>
<span class="sd">            conf_int (str): which method to compute confidence intervals; &#39;profile&#39;, &#39;Wald&#39; (default), or &#39;boot&#39; (parametric bootstrap)</span>
<span class="sd">            n_boot (int): number of bootstrap intervals if bootstrapped confidence intervals are requests; default 500</span>
<span class="sd">            factors (dict): Keys should be column names in data to treat as factors. Values should either be a list containing unique variable levels if dummy-coding or polynomial coding is desired. Otherwise values should be another dictionary with unique variable levels as keys and desired contrast values (as specified in R!) as keys. See examples below</span>
<span class="sd">            permute (int): if non-zero, computes parameter significance tests by permuting test stastics rather than parametrically. Permutation is done by shuffling observations within clusters to respect random effects structure of data.</span>
<span class="sd">            ordered (bool): whether factors should be treated as ordered polynomial contrasts; this will parameterize a model with K-1 orthogonal polynomial regressors beginning with a linear contrast based on the factor order provided; default is False</span>
<span class="sd">            summarize (bool): whether to print a model summary after fitting; default is True</span>
<span class="sd">            verbose (bool): whether to print when and which model and confidence interval are being fitted</span>
<span class="sd">            REML (bool): whether to fit using restricted maximum likelihood estimation instead of maximum likelihood estimation; default True</span>
<span class="sd">            rank (bool): covert predictors in model formula to ranks by group prior to estimation. Model object will still contain original data not ranked data; default False</span>
<span class="sd">            rank_group (str): column name to group data on prior to rank conversion</span>
<span class="sd">            rank_exclude_cols (list/str): columns in model formula to not apply rank conversion to</span>
<span class="sd">            no_warnings (bool): turn off auto-printing warnings messages; warnings are always stored in the .warnings attribute; default False</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame: R style summary() table</span>

<span class="sd">        Examples:</span>
<span class="sd">            The following examples demonstrate how to treat variables as categorical factors.</span>

<span class="sd">            Dummy-Coding: Treat Col1 as a factor which 3 levels: A, B, C. Use dummy-coding with A as the reference level. Model intercept will be mean of A, and parameters will be B-A, and C-A.</span>

<span class="sd">            &gt;&gt;&gt; model.fit(factors = {&quot;Col1&quot;: [&#39;A&#39;,&#39;B&#39;,&#39;C&#39;]})</span>

<span class="sd">            Orthogonal Polynomials: Treat Col1 as a factor which 3 levels: A, B, C. Estimate a linear contrast of C &gt; B &gt; A. Model intercept will be grand-mean of all levels, and parameters will be linear contrast, and orthogonal polynomial contrast (auto-computed).</span>

<span class="sd">            &gt;&gt;&gt; model.fit(factors = {&quot;Col1&quot;: [&#39;A&#39;,&#39;B&#39;,&#39;C&#39;]}, ordered=True)</span>

<span class="sd">            Custom-contrast: Treat Col1 as a factor which 3 levels: A, B, C. Compare A to the mean of B and C. Model intercept will be the grand-mean of all levels, and parameters will be the desired contrast, a well as an automatically determined orthogonal contrast.</span>

<span class="sd">            &gt;&gt;&gt; model.fit(factors = {&quot;Col1&quot;: {&#39;A&#39;: 1, &#39;B&#39;: -.5, &#39;C&#39;: -.5}}))</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Save params for future calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_permute</span> <span class="o">=</span> <span class="n">permute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conf_int</span> <span class="o">=</span> <span class="n">conf_int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_REML</span> <span class="o">=</span> <span class="n">REML</span>
        <span class="k">if</span> <span class="n">factors</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_factors</span><span class="p">(</span><span class="n">factors</span><span class="p">,</span> <span class="n">ordered</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="o">=</span> <span class="n">factors</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="n">rank</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rank_group</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;rank_group must be provided if rank is True&quot;</span><span class="p">)</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">to_ranks_by_group</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">rank_group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">rank_exclude_cols</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">factors</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">factors</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">rank_exclude_cols</span><span class="p">)):</span>
                <span class="n">w</span> <span class="o">=</span> <span class="s2">&quot;Factors and ranks requested, but factors are not excluded from rank conversion. Are you sure you wanted to do this?&quot;</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conf_int</span> <span class="o">==</span> <span class="s2">&quot;boot&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span> <span class="o">=</span> <span class="s2">&quot;bootstrapped&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">permute</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span> <span class="o">=</span> <span class="s2">&quot;permutation&quot;</span> <span class="o">+</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">permute</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span> <span class="o">=</span> <span class="s2">&quot;parametric&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="n">_fam</span> <span class="o">=</span> <span class="s2">&quot;gaussian&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Fitting linear model using lmer with &quot;</span>
                    <span class="o">+</span> <span class="n">conf_int</span>
                    <span class="o">+</span> <span class="s2">&quot; confidence intervals...</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">lmer</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s2">&quot;lmerTest&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span> <span class="o">=</span> <span class="n">lmer</span><span class="o">.</span><span class="n">lmer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">REML</span><span class="o">=</span><span class="n">REML</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Fitting generalized linear model using glmer (family </span><span class="si">{}</span><span class="s2">) with &quot;</span>
                    <span class="o">+</span> <span class="n">conf_int</span>
                    <span class="o">+</span> <span class="s2">&quot; confidence intervals...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">lmer</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s2">&quot;lme4&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s2">&quot;inverse_gaussian&quot;</span><span class="p">:</span>
                <span class="n">_fam</span> <span class="o">=</span> <span class="s2">&quot;inverse.gaussian&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span>
                <span class="n">_fam</span> <span class="o">=</span> <span class="s2">&quot;Gamma&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span> <span class="o">=</span> <span class="n">lmer</span><span class="o">.</span><span class="n">glmer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">_fam</span><span class="p">,</span> <span class="n">REML</span><span class="o">=</span><span class="n">REML</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">permute</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using </span><span class="si">{}</span><span class="s2"> permutations to determine significance...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">permute</span><span class="p">))</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s2">&quot;base&quot;</span><span class="p">)</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">)</span>
        <span class="n">unsum</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">unclass</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>

        <span class="c1"># Do scalars first cause they&#39;re easier</span>

        <span class="n">r_grps</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">data_frame</span><span class="p">(</span><span class="n">unsum</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;ngrps&quot;</span><span class="p">))</span>
        <span class="n">grps</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">r_grps</span><span class="p">)</span>
        <span class="c1"># Get group names separately cause rpy2 &gt; 2.9 is weird and doesnt return them above</span>
        <span class="n">grp_names</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">rownames</span><span class="p">(</span><span class="n">r_grps</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grps</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">grp_names</span><span class="p">,</span> <span class="n">grps</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">AIC</span> <span class="o">=</span> <span class="n">unsum</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;AICtab&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logLike</span> <span class="o">=</span> <span class="n">unsum</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;logLik&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># First check for lme4 printed messages (e.g. convergence info is usually here instead of in warnings)</span>
        <span class="n">fit_messages</span> <span class="o">=</span> <span class="n">unsum</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;optinfo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;conv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;lme4&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">)</span>
        <span class="c1"># Then check warnings for additional stuff</span>
        <span class="n">fit_warnings</span> <span class="o">=</span> <span class="n">unsum</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;optinfo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;warnings&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fit_warnings</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fit_warnings</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">fit_warnings</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit_warnings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fit_messages</span><span class="p">,</span> <span class="n">rpy2</span><span class="o">.</span><span class="n">rinterface</span><span class="o">.</span><span class="n">RNULLType</span><span class="p">):</span>
            <span class="n">fit_messages</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">fit_messages</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit_messages</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">fit_messages_warnings</span> <span class="o">=</span> <span class="n">fit_messages</span> <span class="o">+</span> <span class="n">fit_warnings</span>
        <span class="k">if</span> <span class="n">fit_messages_warnings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fit_messages_warnings</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_warnings</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">warning</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">warning</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">warning</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Coefficients, and inference statistics</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="s2">&quot;inverse_gaussian&quot;</span><span class="p">,</span> <span class="s2">&quot;poisson&quot;</span><span class="p">]:</span>

            <span class="n">rstring</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                function(model){</span>
<span class="sd">                out.coef &lt;- data.frame(unclass(summary(model))$coefficients)</span>
<span class="sd">                out.ci &lt;- data.frame(confint(model,method=&#39;&quot;&quot;&quot;</span>
                <span class="o">+</span> <span class="n">conf_int</span>
                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;,nsim=&quot;&quot;&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_boot</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;))</span>
<span class="s2">                n &lt;- c(rownames(out.ci))</span>
<span class="s2">                idx &lt;- max(grep(&#39;sig&#39;,n))</span>
<span class="s2">                out.ci &lt;- out.ci[-seq(1:idx),]</span>
<span class="s2">                out &lt;- cbind(out.coef,out.ci)</span>
<span class="s2">                list(out,rownames(out))</span>
<span class="s2">                }</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="p">)</span>
            <span class="n">estimates_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
            <span class="n">out_summary</span><span class="p">,</span> <span class="n">out_rownames</span> <span class="o">=</span> <span class="n">estimates_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">out_summary</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">out_rownames</span>
            <span class="c1"># df = pandas2ri.ri2py(estimates_func(self.model_obj))</span>

            <span class="c1"># gaussian</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;SE&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;DF&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
                    <span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;SE&quot;</span><span class="p">,</span> <span class="s2">&quot;DF&quot;</span><span class="p">,</span> <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span> <span class="s2">&quot;P-val&quot;</span><span class="p">]</span>
                <span class="p">]</span>

            <span class="c1"># gamma, inverse_gaussian</span>
            <span class="k">elif</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="s2">&quot;inverse_gaussian&quot;</span><span class="p">]:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;SE&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;SE&quot;</span><span class="p">,</span> <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span> <span class="s2">&quot;P-val&quot;</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;SE&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Z-stat&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;SE&quot;</span><span class="p">,</span> <span class="s2">&quot;Z-stat&quot;</span><span class="p">,</span> <span class="s2">&quot;P-val&quot;</span><span class="p">]]</span>

            <span class="c1"># Incase lmerTest chokes it won&#39;t return p-values</span>
            <span class="k">elif</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">permute</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;MODELING FIT WARNING! Check model.warnings!! P-value computation did not occur because lmerTest choked. Possible issue(s): ranefx have too many parameters or too little variance...&quot;</span>
                    <span class="p">)</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;SE&quot;</span><span class="p">,</span> <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">]</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;SE&quot;</span><span class="p">,</span> <span class="s2">&quot;T-stat&quot;</span><span class="p">]]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s2">&quot;binomial&quot;</span><span class="p">:</span>

            <span class="n">rstring</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                function(model){</span>
<span class="sd">                out.coef &lt;- data.frame(unclass(summary(model))$coefficients)</span>
<span class="sd">                out.ci &lt;- data.frame(confint(model,method=&#39;&quot;&quot;&quot;</span>
                <span class="o">+</span> <span class="n">conf_int</span>
                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;,nsim=&quot;&quot;&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_boot</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;))</span>
<span class="s2">                n &lt;- c(rownames(out.ci))</span>
<span class="s2">                idx &lt;- max(grep(&#39;sig&#39;,n))</span>
<span class="s2">                out.ci &lt;- out.ci[-seq(1:idx),]</span>
<span class="s2">                out &lt;- cbind(out.coef,out.ci)</span>
<span class="s2">                odds &lt;- exp(out.coef[1])</span>
<span class="s2">                colnames(odds) &lt;- &quot;OR&quot;</span>
<span class="s2">                probs &lt;- data.frame(sapply(out.coef[1],plogis))</span>
<span class="s2">                colnames(probs) &lt;- &quot;Prob&quot;</span>
<span class="s2">                odds.ci &lt;- exp(out.ci)</span>
<span class="s2">                colnames(odds.ci) &lt;- c(&quot;OR_2.5_ci&quot;,&quot;OR_97.5_ci&quot;)</span>
<span class="s2">                probs.ci &lt;- data.frame(sapply(out.ci,plogis))</span>
<span class="s2">                colnames(probs.ci) &lt;- c(&quot;Prob_2.5_ci&quot;,&quot;Prob_97.5_ci&quot;)</span>
<span class="s2">                out &lt;- cbind(out,odds,odds.ci,probs,probs.ci)</span>
<span class="s2">                list(out,rownames(out))</span>
<span class="s2">                }</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="p">)</span>

            <span class="n">estimates_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
            <span class="n">out_summary</span><span class="p">,</span> <span class="n">out_rownames</span> <span class="o">=</span> <span class="n">estimates_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">out_summary</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">out_rownames</span>
            <span class="c1"># df = pandas2ri.ri2py(estimates_func(self.model_obj))</span>

            <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                <span class="s2">&quot;SE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Z-stat&quot;</span><span class="p">,</span>
                <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
                <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
                <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OR&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OR_2.5_ci&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OR_97.5_ci&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Prob&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Prob_2.5_ci&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Prob_97.5_ci&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
                <span class="p">[</span>
                    <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;SE&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;OR&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;OR_2.5_ci&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;OR_97.5_ci&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Prob&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Prob_2.5_ci&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Prob_97.5_ci&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Z-stat&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="n">permute</span><span class="p">:</span>
            <span class="n">perm_dat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">dv_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">grp_vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grps</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">perms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">permute</span><span class="p">):</span>
                <span class="n">perm_dat</span><span class="p">[</span><span class="n">dv_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">perm_dat</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grp_vars</span><span class="p">)[</span><span class="n">dv_var</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
                    <span class="n">perm_obj</span> <span class="o">=</span> <span class="n">lmer</span><span class="o">.</span><span class="n">lmer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">perm_dat</span><span class="p">,</span> <span class="n">REML</span><span class="o">=</span><span class="n">REML</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">perm_obj</span> <span class="o">=</span> <span class="n">lmer</span><span class="o">.</span><span class="n">glmer</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">perm_dat</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">_fam</span><span class="p">,</span> <span class="n">REML</span><span class="o">=</span><span class="n">REML</span>
                    <span class="p">)</span>
                <span class="n">perms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_return_t</span><span class="p">(</span><span class="n">perm_obj</span><span class="p">))</span>
            <span class="n">perms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">perms</span><span class="p">)</span>
            <span class="n">pvals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="s2">&quot;inverse_gaussian&quot;</span><span class="p">]:</span>
                    <span class="n">pvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_perm_find</span><span class="p">(</span><span class="n">perms</span><span class="p">[:,</span> <span class="n">c</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;T-stat&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_perm_find</span><span class="p">(</span><span class="n">perms</span><span class="p">[:,</span> <span class="n">c</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Z-stat&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">]))</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;P-val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvals</span>
            <span class="k">if</span> <span class="s2">&quot;DF&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;DF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">permute</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;DF&quot;</span><span class="p">:</span> <span class="s2">&quot;Num_perm&quot;</span><span class="p">,</span> <span class="s2">&quot;P-val&quot;</span><span class="p">:</span> <span class="s2">&quot;Perm-P-val&quot;</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Num_perm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">permute</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;P-val&quot;</span><span class="p">:</span> <span class="s2">&quot;Perm-P-val&quot;</span><span class="p">})</span>

        <span class="k">if</span> <span class="s2">&quot;P-val&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;P-val&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_sig_stars</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s2">&quot;Perm-P-val&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Perm-P-val&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_sig_stars</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">conf_int</span> <span class="o">==</span> <span class="s2">&quot;boot&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">permute</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># We&#39;re computing parametrically bootstrapped ci&#39;s so it doesn&#39;t make sense to use approximation for p-values. Instead remove those from the output and make significant inferences based on whether the bootstrapped ci&#39;s cross 0.</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;P-val&quot;</span><span class="p">,</span> <span class="s2">&quot;Sig&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;DF&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;DF&quot;</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;2.5_ci&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;97.5_ci&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">permute</span><span class="p">:</span>
            <span class="c1"># Because all models except lmm have no DF column make sure Num_perm gets put in the right place</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">col_order</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Num_perm&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_order</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Random effect variances and correlations</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">data_frame</span><span class="p">(</span><span class="n">unsum</span><span class="o">.</span><span class="n">rx2</span><span class="p">(</span><span class="s2">&quot;varcor&quot;</span><span class="p">)))</span>
        <span class="n">ran_vars</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;(var2 == &#39;NA&#39;) | (var2 == &#39;N&#39;)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;var2&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ran_vars</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ran_vars</span><span class="p">[</span><span class="s2">&quot;grp&quot;</span><span class="p">]</span>
        <span class="n">ran_vars</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;grp&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ran_vars</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Var&quot;</span><span class="p">,</span> <span class="s2">&quot;Std&quot;</span><span class="p">]</span>
        <span class="n">ran_vars</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ran_vars</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">ran_corrs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;(var2 != &#39;NA&#39;) &amp; (var2 != &#39;N&#39;)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;vcov&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ran_corrs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ran_corrs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ran_corrs</span><span class="p">[</span><span class="s2">&quot;grp&quot;</span><span class="p">]</span>
            <span class="n">ran_corrs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;grp&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ran_corrs</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;IV1&quot;</span><span class="p">,</span> <span class="s2">&quot;IV2&quot;</span><span class="p">,</span> <span class="s2">&quot;Corr&quot;</span><span class="p">]</span>
            <span class="n">ran_corrs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ran_corrs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ranef_var</span> <span class="o">=</span> <span class="n">ran_vars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranef_corr</span> <span class="o">=</span> <span class="n">ran_corrs</span>

        <span class="c1"># Cluster (e.g subject) level coefficients</span>
        <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            function(model){</span>
<span class="s2">            out &lt;- coef(model)</span>
<span class="s2">            out</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">fixef_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="n">fixefs</span> <span class="o">=</span> <span class="n">fixef_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixefs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">f_corrected_order</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fixefs</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">f_corrected_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">f</span><span class="p">[</span>
                        <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                        <span class="o">+</span> <span class="p">[</span><span class="n">elem</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span> <span class="o">=</span> <span class="n">f_corrected_order</span>
            <span class="c1"># self.fixef = [pandas2ri.ri2py(f) for f in fixefs]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">fixefs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="p">[</span>
                <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">[</span><span class="n">elem</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
            <span class="p">]</span>

        <span class="c1"># Sort column order to match population coefs</span>
        <span class="c1"># This also handles cases in which random slope terms exist in the model without corresponding fixed effects terms, which generates extra columns in this dataframe. By default put those columns *after* the fixed effect columns of interest (i.e. population coefs)</span>

        <span class="c1"># Cluster (e.g subject) level random deviations</span>
        <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            function(model){</span>
<span class="s2">            uniquify &lt;- function(df){</span>
<span class="s2">            colnames(df) &lt;- make.unique(colnames(df))</span>
<span class="s2">            df</span>
<span class="s2">            }</span>
<span class="s2">            out &lt;- lapply(ranef(model),uniquify)</span>
<span class="s2">            out</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">ranef_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="n">ranefs</span> <span class="o">=</span> <span class="n">ranef_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranefs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranef</span> <span class="o">=</span> <span class="p">[</span><span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranefs</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranef</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">ranefs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Save the design matrix</span>
        <span class="c1"># Make sure column names match population coefficients</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s2">&quot;stats&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">index</span><span class="p">[:]</span>
        <span class="p">)</span>

        <span class="c1"># Model residuals</span>
        <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            function(model){</span>
<span class="s2">            out &lt;- resid(model)</span>
<span class="s2">            out</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">resid_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resid</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">resid_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;residuals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span>

        <span class="c1"># Model fits</span>
        <span class="n">rstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            function(model){</span>
<span class="s2">            out &lt;- fitted(model)</span>
<span class="s2">            out</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">fit_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">fit_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">summarize</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span></div>

<div class="viewcode-block" id="Lmer.simulate"><a class="viewcode-back" href="../../api.html#pymer4.models.Lmer.simulate">[docs]</a>    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_datasets</span><span class="p">,</span> <span class="n">use_rfx</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulate new responses based upon estimates from a fitted model. By default group/cluster means for simulated data will match those of the original data. Unlike predict, this is a non-deterministic operation because lmer will sample random-efects values for all groups/cluster and then sample data points from their respective conditional distributions.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_datasets (int): number of simulated datasets to generate. Each simulation always generates a dataset that matches the size of the original data</span>
<span class="sd">            use_rfx (bool): match group/cluster means in simulated data?; Default True</span>

<span class="sd">        Returns:</span>
<span class="sd">            ndarray: simulated data values</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_datasets</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">num_datasets</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_datasets</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_datasets</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_datasets must be an integer&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_rfx</span><span class="p">:</span>
            <span class="n">re_form</span> <span class="o">=</span> <span class="s2">&quot;NULL&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">re_form</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>

        <span class="n">rstring</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            function(model){</span>
<span class="sd">            out &lt;- simulate(model,&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_datasets</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;,allow.new.levels=TRUE,re.form=&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="n">re_form</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;)</span>
<span class="s2">            out</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">simulate_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="n">sims</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">simulate_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">sims</span></div>

<div class="viewcode-block" id="Lmer.predict"><a class="viewcode-back" href="../../api.html#pymer4.models.Lmer.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">use_rfx</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pred_type</span><span class="o">=</span><span class="s2">&quot;response&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make predictions given new data. Input must be a dataframe that contains the same columns as the model.matrix excluding the intercept (i.e. all the predictor variables used to fit the model). If using random effects to make predictions, input data must also contain a column for the group identifier that were used to fit the model random effects terms. Using random effects to make predictions only makes sense if predictions are being made about the same groups/clusters.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (pandas.core.frame.DataFrame): input data to make predictions on</span>
<span class="sd">            use_rfx (bool): whether to condition on random effects when making predictions</span>
<span class="sd">            pred_type (str): whether the prediction should be on the &#39;response&#39; scale (default); or on the &#39;link&#39; scale of the predictors passed through the link function (e.g. log-odds scale in a logit model instead of probability values)</span>

<span class="sd">        Returns:</span>
<span class="sd">            ndarray: prediction values</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">required_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_cols</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Column names do not match all fixed effects model terms!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_rfx</span><span class="p">:</span>
            <span class="n">required_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">required_cols</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grps</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_cols</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Column names are missing random effects model grouping terms!&quot;</span>
                <span class="p">)</span>

            <span class="n">re_form</span> <span class="o">=</span> <span class="s2">&quot;NULL&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">re_form</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>

        <span class="n">rstring</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            function(model,new){</span>
<span class="sd">            out &lt;- predict(model,new,allow.new.levels=TRUE,re.form=&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="n">re_form</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;,type=&#39;&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="n">pred_type</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;)</span>
<span class="s2">            out</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="n">predict_func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">predict_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">preds</span></div>

<div class="viewcode-block" id="Lmer.summary"><a class="viewcode-back" href="../../api.html#pymer4.models.Lmer.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summarize the output of a fitted model.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted to generate summary!&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Formula: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Family: </span><span class="si">{}</span><span class="se">\t</span><span class="s2"> Inference: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Number of observations: </span><span class="si">%s</span><span class="se">\t</span><span class="s2"> Groups: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">grps</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Log-likelihood: </span><span class="si">%.3f</span><span class="s2"> </span><span class="se">\t</span><span class="s2"> AIC: </span><span class="si">%.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logLike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Random effects:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ranef_var</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranef_corr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ranef_corr</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No random effect correlations specified</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fixed effects:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></div>

<div class="viewcode-block" id="Lmer.post_hoc"><a class="viewcode-back" href="../../api.html#pymer4.models.Lmer.post_hoc">[docs]</a>    <span class="k">def</span> <span class="nf">post_hoc</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">marginal_vars</span><span class="p">,</span> <span class="n">grouping_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">p_adjust</span><span class="o">=</span><span class="s2">&quot;tukey&quot;</span><span class="p">,</span> <span class="n">summarize</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Post-hoc pair-wise tests corrected for multiple comparisons (Tukey method) implemented using the lsmeans package. This method provide both marginal means/trends along with marginal pairwise differences. More info can be found at: https://cran.r-project.org/web/packages/lsmeans/lsmeans.pdf</span>

<span class="sd">        Args:</span>
<span class="sd">            marginal_var (str/list): what variable(s) to compute marginal means/trends for; unique combinations of factor levels of these variable(s) will determine family-wise error correction</span>
<span class="sd">            grouping_vars (str/list): what variable(s) to group on. Trends/means/comparisons of other variable(s), will be computed at each level of these variable(s)</span>
<span class="sd">            p_adjust (str): multiple comparisons adjustment method. One of: tukey, bonf, fdr, hochberg, hommel, holm, dunnet, mvt (monte-carlo multi-variate T, aka exact tukey/dunnet). Default tukey</span>
<span class="sd">            summarize (bool): output effects and contrasts or don&#39;t (always stored in model object as model.marginal_estimates and model.marginal_contrasts); default True</span>

<span class="sd">        Returns:</span>
<span class="sd">            marginal_estimates (pd.Dataframe): unique factor level effects (e.g. means/coefs)</span>
<span class="sd">            marginal_contrasts (pd.DataFrame): contrasts between factor levels</span>

<span class="sd">        Examples:</span>

<span class="sd">            Pairwise comparison of means of A at each level of B</span>

<span class="sd">            &gt;&gt;&gt; model.post_hoc(marginal_vars=&#39;A&#39;,grouping_vars=&#39;B&#39;)</span>

<span class="sd">            Pairwise differences of slopes of C between levels of A at each level of B</span>

<span class="sd">            &gt;&gt;&gt; model.post_hoc(marginal_vars=&#39;C&#39;,grouping_vars=[&#39;A&#39;,&#39;B&#39;])</span>

<span class="sd">            Pairwise differences of each unique A,B cell</span>

<span class="sd">            &gt;&gt;&gt; model.post_hoc(marginal_vars=[&#39;A&#39;,&#39;B&#39;])</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">marginal_vars</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide marginal_vars&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted to generate post-hoc comparisons&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">marginal_vars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">marginal_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">marginal_vars</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">grouping_vars</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">grouping_vars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">grouping_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">grouping_vars</span><span class="p">]</span>
            <span class="c1"># Conditional vars can only be factor types</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">grouping_vars</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;All grouping_vars must be existing categorical variables (i.e. factors)&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Need to figure out if marginal_vars is continuous or not to determine lstrends or lsmeans call</span>
        <span class="n">cont</span><span class="p">,</span> <span class="n">factor</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">marginal_vars</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="ow">or</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">cont</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">factor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cont</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">factor</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;With more than one marginal variable, all variables must be categorical factors. Mixing continuous and categorical variables is not supported. Try passing additional categorical factors to grouping_vars&quot;</span>
                    <span class="s2">&quot;&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cont</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Marginal variables can only contain one continuous variable&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cont</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">grouping_vars</span><span class="p">:</span>
                        <span class="c1"># Lstrends</span>
                        <span class="n">cont</span> <span class="o">=</span> <span class="n">cont</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grouping_vars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">g1</span> <span class="o">=</span> <span class="n">grouping_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">_conditional</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grouping_vars</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

                            <span class="n">rstring</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                                function(model){</span>
<span class="sd">                                suppressMessages(library(lsmeans))</span>
<span class="sd">                                out &lt;- lstrends(model,pairwise ~ &quot;&quot;&quot;</span>
                                <span class="o">+</span> <span class="n">g1</span>
                                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;|&quot;&quot;&quot;</span>
                                <span class="o">+</span> <span class="n">_conditional</span>
                                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;,var=&#39;&quot;&quot;&quot;</span>
                                <span class="o">+</span> <span class="n">cont</span>
                                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;,adjust=&#39;&quot;&quot;&quot;</span>
                                <span class="o">+</span> <span class="n">p_adjust</span>
                                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;)</span>
<span class="s2">                                out</span>
<span class="s2">                                }&quot;&quot;&quot;</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">rstring</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                                function(model){</span>
<span class="sd">                                suppressMessages(library(lsmeans))</span>
<span class="sd">                                out &lt;- lstrends(model,pairwise ~ &quot;&quot;&quot;</span>
                                <span class="o">+</span> <span class="n">grouping_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;,var=&#39;&quot;&quot;&quot;</span>
                                <span class="o">+</span> <span class="n">cont</span>
                                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;,adjust=&#39;&quot;&quot;&quot;</span>
                                <span class="o">+</span> <span class="n">p_adjust</span>
                                <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;)</span>
<span class="s2">                                out</span>
<span class="s2">                                }&quot;&quot;&quot;</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;grouping_vars are required with a continuous marginal_vars&quot;</span>
                        <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">factor</span><span class="p">:</span>
                <span class="n">_marginal</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">grouping_vars</span><span class="p">:</span>
                    <span class="c1"># Lsmeans with pipe</span>
                    <span class="n">_conditional</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grouping_vars</span><span class="p">)</span>
                    <span class="n">rstring</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        function(model){</span>
<span class="sd">                        suppressMessages(library(lsmeans))</span>
<span class="sd">                        out &lt;- lsmeans(model,pairwise ~ &quot;&quot;&quot;</span>
                        <span class="o">+</span> <span class="n">_marginal</span>
                        <span class="o">+</span> <span class="s2">&quot;&quot;&quot;|&quot;&quot;&quot;</span>
                        <span class="o">+</span> <span class="n">_conditional</span>
                        <span class="o">+</span> <span class="s2">&quot;&quot;&quot;, adjust=&#39;&quot;&quot;&quot;</span>
                        <span class="o">+</span> <span class="n">p_adjust</span>
                        <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;)</span>
<span class="s2">                        out</span>
<span class="s2">                        }&quot;&quot;&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Lsmeans without pipe</span>
                    <span class="n">rstring</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        function(model){</span>
<span class="sd">                        suppressMessages(library(lsmeans))</span>
<span class="sd">                        out &lt;- lsmeans(model,pairwise ~ &quot;&quot;&quot;</span>
                        <span class="o">+</span> <span class="n">_marginal</span>
                        <span class="o">+</span> <span class="s2">&quot;&quot;&quot;,adjust=&#39;&quot;&quot;&quot;</span>
                        <span class="o">+</span> <span class="n">p_adjust</span>
                        <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;)</span>
<span class="s2">                        out</span>
<span class="s2">                        }&quot;&quot;&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;marginal_vars are not in model!&quot;</span><span class="p">)</span>

        <span class="n">func</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">rstring</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s2">&quot;base&quot;</span><span class="p">)</span>
        <span class="n">lsmeans</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s2">&quot;lsmeans&quot;</span><span class="p">)</span>

        <span class="c1"># Marginal estimates</span>
        <span class="c1"># self.marginal_estimates = pandas2ri.ri2py(base.summary(res.rx2(&#39;lsmeans&#39;)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">res</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Resort columns</span>
        <span class="n">effect_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
        <span class="c1"># this column name changes depending on whether we&#39;re doing post-hoc trends or means</span>
        <span class="n">effname</span> <span class="o">=</span> <span class="n">effect_names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">sorted</span> <span class="o">=</span> <span class="n">effect_names</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;SE&quot;</span><span class="p">,</span> <span class="s2">&quot;DF&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="n">effname</span><span class="p">:</span> <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="s2">&quot;DF&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lower.CL&quot;</span><span class="p">:</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
                <span class="s2">&quot;upper.CL&quot;</span><span class="p">:</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)[</span><span class="nb">sorted</span><span class="p">]</span>

        <span class="c1"># Marginal Contrasts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">res</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;t.ratio&quot;</span><span class="p">:</span> <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span>
                <span class="s2">&quot;p.value&quot;</span><span class="p">:</span> <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
                <span class="s2">&quot;estimate&quot;</span><span class="p">:</span> <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="s2">&quot;DF&quot;</span><span class="p">,</span>
                <span class="s2">&quot;contrast&quot;</span><span class="p">:</span> <span class="s2">&quot;Contrast&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="c1"># Need to make another call to lsmeans to get confidence intervals on contrasts</span>
        <span class="n">confs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">unclass</span><span class="p">(</span><span class="n">lsmeans</span><span class="o">.</span><span class="n">confint_ref_grid</span><span class="p">(</span><span class="n">res</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span>
            <span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lower.CL&quot;</span><span class="p">:</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;upper.CL&quot;</span><span class="p">:</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">})</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="p">,</span> <span class="n">confs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Resort columns</span>
        <span class="n">effect_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">7</span><span class="p">])</span>
        <span class="nb">sorted</span> <span class="o">=</span> <span class="n">effect_names</span> <span class="o">+</span> <span class="p">[</span>
            <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
            <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DF&quot;</span><span class="p">,</span>
            <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="p">[</span><span class="nb">sorted</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="p">[</span><span class="s2">&quot;Sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="p">[</span><span class="s2">&quot;P-val&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">_sig_stars</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">p_adjust</span> <span class="o">==</span> <span class="s2">&quot;tukey&quot;</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;P-values adjusted by tukey method for family of </span><span class="si">{}</span><span class="s2"> estimates&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="p">[</span><span class="s2">&quot;Contrast&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">p_adjust</span> <span class="o">!=</span> <span class="s2">&quot;tukey&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;P-values adjusted by </span><span class="si">{}</span><span class="s2"> method for </span><span class="si">{}</span><span class="s2"> comparisons&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">p_adjust</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="p">[</span><span class="s2">&quot;Contrast&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">summarize</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_estimates</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_contrasts</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></div>

<div class="viewcode-block" id="Lmer.plot_summary"><a class="viewcode-back" href="../../api.html#pymer4.models.Lmer.plot_summary">[docs]</a>    <span class="k">def</span> <span class="nf">plot_summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="n">error_bars</span><span class="o">=</span><span class="s2">&quot;ci&quot;</span><span class="p">,</span>
        <span class="n">ranef</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">axlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ranef_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">coef_fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
        <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;v&#39;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a forestplot overlaying estimated coefficients with random effects (i.e. BLUPs). By default display the 95% confidence intervals computed during fitting.</span>

<span class="sd">        Args:</span>
<span class="sd">            error_bars (str): one of &#39;ci&#39; or &#39;se&#39; to change which error bars are plotted; default &#39;ci&#39;</span>
<span class="sd">            ranef (bool): overlay BLUP estimates on figure; default True</span>
<span class="sd">            axlim (tuple): lower and upper limit of plot; default min and max of BLUPs</span>
<span class="sd">            intercept (bool): plot the intercept estimate; default True</span>
<span class="sd">            ranef_alpha (float): opacity of random effect points; default .5</span>
<span class="sd">            coef_fmt (str): matplotlib marker style for population coefficients</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib axis handle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model must be fit before plotting!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orient</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;orientation must be &#39;h&#39; or &#39;v&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">ranef_idx</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ranef_idx&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Multiple random effects clusters specified in model. Plotting the </span><span class="si">{}</span><span class="s2"> one. This can be changed by passing &#39;ranef_idx = number&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">ranef_idx</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">m_ranef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="p">[</span><span class="n">ranef_idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m_ranef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span>
        <span class="n">m_fixef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">intercept</span><span class="p">:</span>
            <span class="n">m_ranef</span> <span class="o">=</span> <span class="n">m_ranef</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">m_fixef</span> <span class="o">=</span> <span class="n">m_fixef</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">error_bars</span> <span class="o">==</span> <span class="s2">&quot;ci&quot;</span><span class="p">:</span>
            <span class="n">col_lb</span> <span class="o">=</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;2.5_ci&quot;</span><span class="p">]</span>
            <span class="n">col_ub</span> <span class="o">=</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;97.5_ci&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">error_bars</span> <span class="o">==</span> <span class="s2">&quot;se&quot;</span><span class="p">:</span>
            <span class="n">col_lb</span><span class="p">,</span> <span class="n">col_ub</span> <span class="o">=</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;SE&quot;</span><span class="p">],</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;SE&quot;</span><span class="p">]</span>

        <span class="c1"># For seaborn</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">m_ranef</span><span class="p">)</span>

        <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ranef</span><span class="p">:</span>
            <span class="n">alpha_plot</span> <span class="o">=</span> <span class="n">ranef_alpha</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alpha_plot</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">orient</span> <span class="o">==</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span>
            <span class="n">x_strip</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span>
            <span class="n">x_err</span> <span class="o">=</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s1">&#39;Estimate&#39;</span><span class="p">]</span>
            <span class="n">y_strip</span> <span class="o">=</span> <span class="s1">&#39;variable&#39;</span>
            <span class="n">y_err</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">m_fixef</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_lb</span><span class="p">,</span> <span class="n">col_ub</span><span class="p">]</span>
            <span class="n">yerr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyles</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">axlim</span><span class="p">:</span>
                <span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xlim</span> <span class="o">=</span> <span class="n">axlim</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_strip</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span>
            <span class="n">y_err</span> <span class="o">=</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s1">&#39;Estimate&#39;</span><span class="p">]</span>
            <span class="n">x_strip</span> <span class="o">=</span> <span class="s1">&#39;variable&#39;</span>
            <span class="n">x_err</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">m_fixef</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">yerr</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_lb</span><span class="p">,</span> <span class="n">col_ub</span><span class="p">]</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyles</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">axlim</span><span class="p">:</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="n">axlim</span>
            <span class="n">xlim</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_strip</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y_strip</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_plot</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_err</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y_err</span><span class="p">,</span>
            <span class="n">xerr</span><span class="o">=</span><span class="n">xerr</span><span class="p">,</span>
            <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="n">coef_fmt</span><span class="p">,</span>
            <span class="n">capsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">elinewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">ms</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">9999999999</span><span class="p">,</span>
        <span class="p">)</span>
       
        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="Lmer.plot"><a class="viewcode-back" href="../../api.html#pymer4.models.Lmer.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">param</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">plot_fixef</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">plot_ci</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">grps</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot random and group level parameters from a fitted model</span>

<span class="sd">        Args:</span>
<span class="sd">            param (str): model parameter (column name) to plot</span>
<span class="sd">            figsize (tup): matplotlib desired figsize</span>
<span class="sd">            xlabel (str): x-axis label</span>
<span class="sd">            ylabel (str): y-axis label</span>
<span class="sd">            plot_fixef (bool): plot population effect fit of param?; default True</span>
<span class="sd">            plot_ci (bool): plot computed ci&#39;s of population effect?; default True</span>
<span class="sd">            grps (list): plot specific group fits only; must correspond to index values in model.fixef</span>
<span class="sd">            ax (matplotlib.axes.Axes): axis handle for an existing plot; if provided will ensure that random parameter plots appear *behind* all other plot objects.</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib axis handle</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model must be fit before plotting!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Plotting can currently only handle models with continuous predictors!&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ranef</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Plotting can currently only handle models with 1 random effect grouping variable!&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ax</span><span class="p">:</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="c1"># Get range of unique values for desired parameter</span>
        <span class="n">x_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="c1"># Sort order to handle bug in matplotlib plotting</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span>

        <span class="c1"># Get desired parameter part of the prediction</span>
        <span class="n">fixef_pred</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">,</span> <span class="s2">&quot;Estimate&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">param</span><span class="p">,</span> <span class="s2">&quot;Estimate&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_vals</span>
        <span class="p">)</span>
        <span class="n">fixef_pred_upper</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">param</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_vals</span>
        <span class="p">)</span>
        <span class="n">fixef_pred_lower</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">param</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_vals</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">grps</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grps</span><span class="p">):</span>
                <span class="n">ran_dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">grps</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grps</span><span class="p">):</span>
                <span class="n">ran_dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grps</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;grps must be integer list for integer-indexing (.iloc) of fixed effects, or label list for label-indexing (.loc) of fixed effects&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ran_dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span>

        <span class="c1"># Now generate random effects predictions</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">ran_dat</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

            <span class="n">ranef_desired</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_vals</span>
            <span class="c1"># ranef_other = np.dot(other_vals_means, row.loc[other_vals])</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">ranef_desired</span>  <span class="c1"># + ranef_other</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">pred</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_fixef</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">x_vals</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="n">fixef_pred</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">9999999</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_ci</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="n">x_vals</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="n">fixef_pred_lower</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="n">fixef_pred_upper</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">9999998</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
            <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="n">x_vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x_vals</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="n">param</span><span class="p">,</span>
            <span class="n">ylabel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">xlabel</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ylabel</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div></div>


<div class="viewcode-block" id="Lm"><a class="viewcode-back" href="../../api.html#pymer4.models.Lm">[docs]</a><span class="k">class</span> <span class="nc">Lm</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model class to perform OLS regression. Formula specification works just like in R based on columns of a dataframe. Formulae are parsed by patsy which makes it easy to utilize specifiy columns as factors. This is **different** from Lmer. See patsy for more information on the different use cases.</span>

<span class="sd">    Args:</span>
<span class="sd">        formula (str): Complete lm-style model formula</span>
<span class="sd">        data (pandas.core.frame.DataFrame): input data</span>
<span class="sd">        family (string): what distribution family (i.e.) link function to use for the generalized model; default is gaussian (linear model)</span>

<span class="sd">    Attributes:</span>
<span class="sd">        fitted (bool): whether model has been fit</span>
<span class="sd">        formula (str): model formula</span>
<span class="sd">        data (pandas.core.frame.DataFrame): model copy of input data</span>
<span class="sd">        grps (dict): groups and number of observations per groups recognized by lmer</span>
<span class="sd">        AIC (float): model akaike information criterion</span>
<span class="sd">        logLike (float): model Log-likelihood</span>
<span class="sd">        family (string): model family</span>
<span class="sd">        ranef (pandas.core.frame.DataFrame/list): cluster-level differences from population parameters, i.e. difference between coefs and fixefs; returns list if multiple cluster variables are used to specify random effects (e.g. subjects and items)</span>
<span class="sd">        fixef (pandas.core.frame.DataFrame/list): cluster-level parameters; returns list if multiple cluster variables are used to specify random effects (e.g. subjects and items)</span>
<span class="sd">        coefs (pandas.core.frame.DataFrame/list): model summary table of population parameters</span>
<span class="sd">        resid (numpy.ndarray): model residuals</span>
<span class="sd">        fits (numpy.ndarray): model fits/predictions</span>
<span class="sd">        model_obj(lm model): rpy2 lmer model object</span>
<span class="sd">        factors (dict): factors used to fit the model if any</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">family</span>
        <span class="c1"># implemented_fams = [&#39;gaussian&#39;,&#39;binomial&#39;]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">!=</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Currently only linear (family =&#39;gaussian&#39;) models supported! &quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AIC</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logLike</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">se_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranked_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimator</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">(fitted=</span><span class="si">{}</span><span class="s2">, formula=</span><span class="si">{}</span><span class="s2">, family=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

<div class="viewcode-block" id="Lm.fit"><a class="viewcode-back" href="../../api.html#pymer4.models.Lm.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">robust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">conf_int</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span>
        <span class="n">permute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">rank</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">summarize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">n_boot</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">n_lags</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">cluster</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wls_dof_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a variety of OLS models. By default will fit a model that makes parametric assumptions (under a t-distribution) replicating the output of software like R. 95% confidence intervals (CIs) are also estimated parametrically by default. However, empirical bootstrapping can also be used to compute CIs; this procedure resamples with replacement from the data themselves, not residuals or data generated from fitted parameters and will be used for inference unless permutation tests are requested. Permutation testing will shuffle observations to generate a null distribution of t-statistics to perform inference on each regressor (permuted t-test).</span>

<span class="sd">        Alternatively, OLS robust to heteroscedasticity can be fit by computing sandwich standard error estimates (good ref: https://bit.ly/2VRb7jK). This is similar to Stata&#39;s robust routine. Of the choices below, &#39;hc1&#39; or &#39;hc3&#39; are amongst the more popular.  </span>
<span class="sd">        Robust estimators include:</span>

<span class="sd">        - &#39;hc0&#39;: Huber (1967) original sandwich estimator</span>

<span class="sd">        - &#39;hc1&#39;: Hinkley (1977) DOF adjustment to &#39;hc0&#39; to account for small sample sizes (default)</span>

<span class="sd">        - &#39;hc2&#39;: different kind of small-sample adjustment of &#39;hc0&#39; by leverage values in hat matrix</span>

<span class="sd">        - &#39;hc3&#39;: MacKinnon and White (1985) HC3 sandwich estimator; provides more robustness in smaller samples than hc2, Long &amp; Ervin (2000)</span>

<span class="sd">        - &#39;hac&#39;: Newey-West (1987) estimator for robustness to heteroscedasticity as well as serial auto-correlation at given lags.</span>

<span class="sd">        - &#39;cluster&#39; : cluster-robust standard errors (see Cameron &amp; Miller 2015 for review). Provides robustness to errors that cluster according to specific groupings (e.g. repeated observations within a person/school/site). This acts as post-modeling &quot;correction&quot; for what a multi-level model explicitly estimates and is popular in the econometrics literature. DOF correction differs slightly from stat/statsmodels which use num_clusters - 1, where as pymer4 uses num_clusters - num_coefs</span>

<span class="sd">        Finally, weighted-least-squares (WLS) can be computed as an alternative to to hetereoscedasticity robust standard errors. This can be estimated by providing an array or series of weights (1 / variance of each group) with the same length as the number of observations or a column to use to compute group variances (which can be the same as the predictor column). This is often useful if some predictor(s) is categorical (e.g. dummy-coded) and taking into account unequal group variances is desired (i.e. in the simplest case this would be equivalent to peforming Welch&#39;s t-test). E.g:</span>


<span class="sd">        Args:</span>
<span class="sd">            robust (bool/str): whether to use heteroscedasticity robust s.e. and optionally which estimator type to use (&#39;hc0&#39;,&#39;hc1&#39;, &#39;hc2&#39;, hc3&#39;,&#39;hac&#39;,&#39;cluster&#39;). If robust = True, default robust estimator is &#39;hc1&#39;; default False</span>
<span class="sd">            conf_int (str): whether confidence intervals should be computed through bootstrap (&#39;boot&#39;) or assuming a t-distribution (&#39;standard&#39;); default &#39;standard&#39;</span>
<span class="sd">            permute (int): if non-zero, computes parameter significance tests by permuting t-stastics rather than parametrically; works with robust estimators</span>
<span class="sd">            rank (bool): convert all predictors and dependent variable to ranks before estimating model; default False</span>
<span class="sd">            summarize (bool): whether to print a model summary after fitting; default True</span>
<span class="sd">            verbose (bool): whether to print which model, standard error, confidence interval, and inference type are being fitted</span>
<span class="sd">            n_boot (int): how many bootstrap resamples to use for confidence intervals (ignored unless conf_int=&#39;boot&#39;)</span>
<span class="sd">            n_jobs (int): number of cores for parallelizing bootstrapping or permutations; default 1</span>
<span class="sd">            n_lags (int): number of lags for robust estimator type &#39;hac&#39; (ignored unless robust=&#39;hac&#39;); default 1</span>
<span class="sd">            cluster (str): column name identifying clusters/groups for robust estimator type &#39;cluster&#39; (ignored unless robust=&#39;cluster&#39;)</span>
<span class="sd">            weights (string/pd.Series/np.ndarray): weights to perform WLS instead of OLS. Pass in a column name in data to use to compute group variances and automatically adjust dof. Otherwise provide an array or series containing 1 / variance of each observation, in which case dof correction will not occur.</span>
<span class="sd">            wls_dof_correction (bool): whether to apply Welch-Satterthwaite approximate correction for dof when using weights based on an existing column in the data, ignored otherwise. Set to False to force standard dof calculation</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame: R style summary() table</span>

<span class="sd">        </span>
<span class="sd">        Examples:</span>

<span class="sd">            Simple regression that estimates a between groups t-test but not assuming equal variances  </span>

<span class="sd">            &gt;&gt;&gt; model = Lm(&#39;DV ~ Group&#39;, data=df)</span>

<span class="sd">            Have pymer4 compute the between group variances automatically (preferred)  </span>

<span class="sd">            &gt;&gt;&gt; model.fit(weights=&#39;Group&#39;) </span>

<span class="sd">            Separately compute the variance of each group and use the inverse of that as the weights; dof correction won&#39;t be applied because its not trivial to compute  </span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; weights = 1 / df.groupby(&quot;Group&quot;)[&#39;DV&#39;].transform(np.var,ddof=1)</span>
<span class="sd">            model.fit(weights=weights)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">permute</span> <span class="ow">and</span> <span class="n">permute</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="s2">&quot;Permutation testing &lt; 500 permutations is not recommended&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">robust</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">robust</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">robust</span> <span class="o">=</span> <span class="s2">&quot;hc1&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">se_type</span> <span class="o">=</span> <span class="s2">&quot;robust&quot;</span> <span class="o">+</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="n">robust</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="k">if</span> <span class="n">cluster</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cluster</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;cluster identifier must be an existing column in data&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">se_type</span> <span class="o">=</span> <span class="s2">&quot;non-robust&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rank</span><span class="p">:</span>
                    <span class="n">print_rank</span> <span class="o">=</span> <span class="s2">&quot;rank&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">print_rank</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">robust</span><span class="p">:</span>
                    <span class="n">print_robust</span> <span class="o">=</span> <span class="s2">&quot;non-robust&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">print_robust</span> <span class="o">=</span> <span class="s2">&quot;robust &quot;</span> <span class="o">+</span> <span class="n">robust</span>

                <span class="k">if</span> <span class="n">conf_int</span> <span class="o">==</span> <span class="s2">&quot;boot&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Fitting &quot;</span>
                        <span class="o">+</span> <span class="n">print_rank</span>
                        <span class="o">+</span> <span class="s2">&quot; model with &quot;</span>
                        <span class="o">+</span> <span class="n">print_robust</span>
                        <span class="o">+</span> <span class="s2">&quot; standard errors and </span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_boot</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;bootstrapped 95</span><span class="si">% c</span><span class="s2">onfidence intervals...</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Fitting &quot;</span>
                        <span class="o">+</span> <span class="n">print_rank</span>
                        <span class="o">+</span> <span class="s2">&quot; model with &quot;</span>
                        <span class="o">+</span> <span class="n">print_robust</span>
                        <span class="o">+</span> <span class="s2">&quot; standard errors</span><span class="se">\n</span><span class="s2">and 95</span><span class="si">% c</span><span class="s2">onfidence intervals...</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">permute</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Using </span><span class="si">{}</span><span class="s2"> permutations to determine significance...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">permute</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ci_type</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">conf_int</span> <span class="o">+</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_boot</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span> <span class="k">if</span> <span class="n">conf_int</span> <span class="o">==</span> <span class="s2">&quot;boot&quot;</span> <span class="k">else</span> <span class="n">conf_int</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">conf_int</span> <span class="o">==</span> <span class="s2">&quot;boot&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">permute</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span> <span class="o">=</span> <span class="s2">&quot;bootstrapped&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">permute</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span> <span class="o">=</span> <span class="s2">&quot;permutation&quot;</span> <span class="o">+</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">permute</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span> <span class="o">=</span> <span class="s2">&quot;parametric&quot;</span>

        <span class="c1"># Parse formula using patsy to make design matrix</span>
        <span class="k">if</span> <span class="n">rank</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranked_data</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ddat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranked_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ddat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># Handle weights if provided</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">weights</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;If weights is a string it must be a column that exists in the data&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">weight_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
                <span class="n">weight_vals</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">weight_groups</span><span class="p">[</span><span class="n">dv</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weight_vals</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">estimator</span> <span class="o">=</span> <span class="s2">&quot;OLS&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">estimator</span> <span class="o">=</span> <span class="s2">&quot;WLS&quot;</span>

        <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">dmatrices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">ddat</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s2">&quot;dataframe&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span> <span class="o">=</span> <span class="n">x</span>

        <span class="c1"># Compute standard estimates</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">_ols</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span>
            <span class="n">y</span><span class="p">,</span>
            <span class="n">robust</span><span class="p">,</span>
            <span class="n">all_stats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">n_lags</span><span class="o">=</span><span class="n">n_lags</span><span class="p">,</span>
            <span class="n">cluster</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">weight_vals</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Cluster corrected dof (num clusters - num coef)</span>
            <span class="c1"># Differs from stats and statsmodels which do num cluster - 1</span>
            <span class="c1"># Ref: http://cameron.econ.ucdavis.edu/research/Cameron_Miller_JHR_2015_February.pdf</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">wls_dof_correction</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">weight_groups</span><span class="o">.</span><span class="n">ngroups</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="s2">&quot;Welch-Satterthwait DOF correction only supported for 2 groups in the data&quot;</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">welch_ingredients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">weights</span><span class="p">)[</span><span class="n">dv</span><span class="p">]</span>
                        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_welch_ingredients</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">welch_ingredients</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="o">/</span> <span class="n">welch_ingredients</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t_dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">df</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">df</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_sig_stars</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">p</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">conf_int</span> <span class="o">==</span> <span class="s2">&quot;boot&quot;</span><span class="p">:</span>

            <span class="c1"># Parallelize bootstrap computation for CIs</span>
            <span class="n">par_for</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;multiprocessing&quot;</span><span class="p">)</span>

            <span class="c1"># To make sure that parallel processes don&#39;t use the same random-number generator pass in seed (sklearn trick)</span>
            <span class="n">seeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_boot</span><span class="p">)</span>

            <span class="c1"># Since we&#39;re bootstrapping coefficients themselves we don&#39;t need the robust info anymore</span>
            <span class="n">boot_betas</span> <span class="o">=</span> <span class="n">par_for</span><span class="p">(</span>
                <span class="n">delayed</span><span class="p">(</span><span class="n">_chunk_boot_ols_coefs</span><span class="p">)(</span>
                    <span class="n">dat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">formula</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seeds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_boot</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">boot_betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">boot_betas</span><span class="p">)</span>
            <span class="n">ci_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">boot_betas</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ci_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">boot_betas</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise we&#39;re doing parametric CIs</span>
            <span class="n">ci_u</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="n">t_dist</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.975</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="n">se</span>
            <span class="n">ci_l</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="n">t_dist</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="n">se</span>

        <span class="k">if</span> <span class="n">permute</span><span class="p">:</span>
            <span class="c1"># Permuting will change degrees of freedom to num_iter and p-values</span>
            <span class="c1"># Parallelize computation</span>
            <span class="c1"># Unfortunate monkey patch that robust estimation hangs with multiple processes; maybe because of function nesting level??</span>
            <span class="c1"># _chunk_perm_ols -&gt; _ols -&gt; _robust_estimator</span>
            <span class="k">if</span> <span class="n">robust</span><span class="p">:</span>
                <span class="n">n_jobs</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">par_for</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;multiprocessing&quot;</span><span class="p">)</span>
            <span class="n">seeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">permute</span><span class="p">)</span>
            <span class="n">perm_ts</span> <span class="o">=</span> <span class="n">par_for</span><span class="p">(</span>
                <span class="n">delayed</span><span class="p">(</span><span class="n">_chunk_perm_ols</span><span class="p">)(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
                    <span class="n">robust</span><span class="o">=</span><span class="n">robust</span><span class="p">,</span>
                    <span class="n">n_lags</span><span class="o">=</span><span class="n">n_lags</span><span class="p">,</span>
                    <span class="n">cluster</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span>
                    <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
                    <span class="n">seed</span><span class="o">=</span><span class="n">seeds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">permute</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">perm_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">perm_ts</span><span class="p">)</span>

            <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">fit_t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">perm_ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">t</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_perm_find</span><span class="p">(</span><span class="n">perm_ts</span><span class="p">[:,</span> <span class="n">col</span><span class="p">],</span> <span class="n">fit_t</span><span class="p">))</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">permute</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_sig_stars</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">p</span><span class="p">])</span>

        <span class="c1"># Make output df</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">b</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">sig</span><span class="p">])</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">results</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
            <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DF&quot;</span><span class="p">,</span>
            <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;P-val&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Sig&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">results</span><span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;SE&quot;</span><span class="p">,</span> <span class="s2">&quot;DF&quot;</span><span class="p">,</span> <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span> <span class="s2">&quot;P-val&quot;</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;SE&quot;</span><span class="p">,</span> <span class="s2">&quot;DF&quot;</span><span class="p">,</span> <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span> <span class="s2">&quot;P-val&quot;</span><span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;coerce&quot;</span><span class="p">,)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">permute</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;DF&quot;</span><span class="p">:</span> <span class="s2">&quot;Num_perm&quot;</span><span class="p">,</span> <span class="s2">&quot;P-val&quot;</span><span class="p">:</span> <span class="s2">&quot;Perm-P-val&quot;</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span> <span class="o">=</span> <span class="n">results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resid</span> <span class="o">=</span> <span class="n">res</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">-</span> <span class="n">res</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">-</span> <span class="n">res</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;residuals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>

        <span class="c1"># Fit statistics</span>
        <span class="k">if</span> <span class="s1">&#39;Intercept&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">center_tss</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">center_tss</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsquared</span> <span class="o">=</span> <span class="n">rsquared</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">res</span><span class="p">,</span> <span class="n">center_tss</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsquared_adj</span> <span class="o">=</span> <span class="n">rsquared_adj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsquared</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">center_tss</span><span class="p">)</span>
        <span class="n">half_obs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">ssr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logLike</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ssr</span><span class="p">)</span> <span class="o">*</span> <span class="n">half_obs</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">half_obs</span><span class="p">))</span> <span class="o">*</span> <span class="n">half_obs</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AIC</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">logLike</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BIC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)))</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">logLike</span>

        <span class="k">if</span> <span class="n">summarize</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span></div>

<div class="viewcode-block" id="Lm.summary"><a class="viewcode-back" href="../../api.html#pymer4.models.Lm.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summarize the output of a fitted model.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model must be fit to generate summary!&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Formula: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Family: </span><span class="si">{}</span><span class="se">\t</span><span class="s2"> Estimator: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Std-errors: </span><span class="si">{}</span><span class="se">\t</span><span class="s2">CIs: </span><span class="si">{}</span><span class="s2"> 95%</span><span class="se">\t</span><span class="s2">Inference: </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">se_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Number of observations: </span><span class="si">%s</span><span class="se">\t</span><span class="s2"> R^2: </span><span class="si">%.3f</span><span class="se">\t</span><span class="s2"> R^2_adj: </span><span class="si">%.3f</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rsquared</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rsquared_adj</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Log-likelihood: </span><span class="si">%.3f</span><span class="s2"> </span><span class="se">\t</span><span class="s2"> AIC: </span><span class="si">%.3f</span><span class="se">\t</span><span class="s2"> BIC: </span><span class="si">%.3f</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logLike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BIC</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fixed effects:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">post_hoc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Post-hoc tests are not yet implemented for linear models.&quot;</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Lm.to_corrs"><a class="viewcode-back" href="../../api.html#pymer4.models.Lm.to_corrs">[docs]</a>    <span class="k">def</span> <span class="nf">to_corrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corr_type</span><span class="o">=</span><span class="s2">&quot;semi&quot;</span><span class="p">,</span> <span class="n">ztrans_corrs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each predictor (except the intercept), compute the partial or semi-partial correlation of the of the predictor with the dependent variable for different interpretability. This does *not* change how inferences are performed, as they are always performed on the betas, not the correlation coefficients. Semi-partial corrs reflect the correlation between a predictor and the dv accounting for correlations between predictors; they are interpretable in the same way as the original betas. Partial corrs reflect the unique variance a predictor explains in the dv accounting for correlations between predictors *and* what is not explained by other predictors; this value is always &gt;= the semi-partial correlation. Good ref: https://bit.ly/2GNwXh5</span>
<span class="sd">         Returns a pandas Series.</span>

<span class="sd">        Args:</span>
<span class="sd">            ztrans_partial_corrs (bool): whether to fisher z-transform (arctan) partial correlations before reporting them; default True</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Model must be fit before partial correlations can be computed&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">corr_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;semi&quot;</span><span class="p">,</span> <span class="s2">&quot;partial&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;corr_type must be &#39;semi&#39; or &#39;partial&#39;&quot;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">pearsonr</span>

        <span class="n">corrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">corrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># don&#39;t compute for intercept</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">dv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">other_preds</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">e</span> <span class="o">!=</span> <span class="n">c</span><span class="p">]</span>
            <span class="n">right_side</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other_preds</span><span class="p">)</span>
            <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">dmatrices</span><span class="p">(</span>
                <span class="n">c</span> <span class="o">+</span> <span class="s2">&quot;~&quot;</span> <span class="o">+</span> <span class="n">right_side</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s2">&quot;dataframe&quot;</span>
            <span class="p">)</span>
            <span class="n">pred_m_resid</span> <span class="o">=</span> <span class="n">_ols</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">y</span><span class="p">,</span>
                <span class="n">robust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">n_lags</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">cluster</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">all_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">resid_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">dmatrices</span><span class="p">(</span>
                <span class="n">dv</span> <span class="o">+</span> <span class="s2">&quot;~&quot;</span> <span class="o">+</span> <span class="n">right_side</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s2">&quot;dataframe&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">corr_type</span> <span class="o">==</span> <span class="s2">&quot;semi&quot;</span><span class="p">:</span>
                <span class="n">dv_m_resid</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">corr_type</span> <span class="o">==</span> <span class="s2">&quot;partial&quot;</span><span class="p">:</span>
                <span class="n">dv_m_resid</span> <span class="o">=</span> <span class="n">_ols</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span>
                    <span class="n">y</span><span class="p">,</span>
                    <span class="n">robust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">n_lags</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">cluster</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">all_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">resid_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">corrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">dv_m_resid</span><span class="p">,</span> <span class="n">pred_m_resid</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ztrans_corrs</span><span class="p">:</span>
            <span class="n">corrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctanh</span><span class="p">(</span><span class="n">corrs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">corrs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span></div>

<div class="viewcode-block" id="Lm.predict"><a class="viewcode-back" href="../../api.html#pymer4.models.Lm.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make predictions given new data. Input must be a dataframe that contains the same columns as the model.matrix excluding the intercept (i.e. all the predictor variables used to fit the model). Will automatically use/ignore intercept to make a prediction if it was/was not part of the original fitted model.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (pandas.core.frame.DataFrame): input data to make predictions on</span>

<span class="sd">        Returns:</span>
<span class="sd">            ndarray: prediction values</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">required_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_cols</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Column names do not match all fixed effects model terms!&quot;</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">required_cols</span><span class="p">]</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;Estimate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Intercept&quot;</span><span class="p">:</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">X</span><span class="p">]),</span> <span class="n">coefs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">coefs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">preds</span></div></div>


<span class="k">class</span> <span class="nc">Lm2</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model class to perform two-stage OLS regression. Practically, a separate regression model is fit to each group in the data and then the coefficients from these regressions are entered into a second-level intercept only model (i.e. 1-sample t-test per coefficient). The results from this second level regression are reported. This is an alternative to using Lmer, as it implicitly allows intercept and slopes to vary by group, however with no prior/smoothing/regularization on the random effects. See https://bit.ly/2SwHhQU and Gelman (2005). This approach maybe less preferable to Lmer if the number of observations per group are few, but the number of groups is large, in which case the 1st-level estimates are much noisier and are not smoothed/regularized as in Lmer. It maybe preferable when a &quot;maximal&quot; rfx Lmer model is not estimable. Formula specification works just like in R based on columns of a dataframe. Formulae are parsed by patsy which makes it easy to utilize specific columns as factors. This is **different** from Lmer. See patsy for more information on the different use cases.</span>

<span class="sd">    Args:</span>
<span class="sd">        formula (str): Complete lm-style model formula</span>
<span class="sd">        data (pandas.core.frame.DataFrame): input data</span>
<span class="sd">        family (string): what distribution family (i.e.) link function to use for the generalized model; default is gaussian (linear model)</span>
<span class="sd">        group (list/string): the grouping variable to use to run the 1st-level regression; if a list is provided will run multiple levels feeding the coefficients from the previous level into the subsequent level</span>

<span class="sd">    Attributes:</span>
<span class="sd">        fitted (bool): whether model has been fit</span>
<span class="sd">        formula (str): model formula</span>
<span class="sd">        data (pandas.core.frame.DataFrame): model copy of input data</span>
<span class="sd">        grps (dict): groups and number of observations per groups recognized by lmer</span>
<span class="sd">        AIC (float): model akaike information criterion</span>
<span class="sd">        logLike (float): model Log-likelihood</span>
<span class="sd">        family (string): model family</span>
<span class="sd">        ranef (pandas.core.frame.DataFrame/list): cluster-level differences from population parameters, i.e. difference between coefs and fixefs; returns list if multiple cluster variables are used to specify random effects (e.g. subjects and items)</span>
<span class="sd">        fixef (pandas.core.frame.DataFrame/list): cluster-level parameters; returns list if multiple cluster variables are used to specify random effects (e.g. subjects and items)</span>
<span class="sd">        coefs (pandas.core.frame.DataFrame/list): model summary table of population parameters</span>
<span class="sd">        resid (numpy.ndarray): model residuals</span>
<span class="sd">        fits (numpy.ndarray): model fits/predictions</span>
<span class="sd">        model_obj(lm model): rpy2 lmer model object</span>
<span class="sd">        factors (dict): factors used to fit the model if any</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">family</span>
        <span class="c1"># implemented_fams = [&#39;gaussian&#39;,&#39;binomial&#39;]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">!=</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Currently only linear (family =&#39;gaussian&#39;) models supported! &quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;group must be a string or list&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AIC</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logLike</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">se_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranked_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iscorrs</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">(fitted=</span><span class="si">{}</span><span class="s2">, formula=</span><span class="si">{}</span><span class="s2">, family=</span><span class="si">{}</span><span class="s2">, group=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">robust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">conf_int</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span>
        <span class="n">permute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">perm_on</span><span class="o">=</span><span class="s2">&quot;t-stat&quot;</span><span class="p">,</span>
        <span class="n">rank</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">summarize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">n_boot</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">n_lags</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">to_corrs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ztrans_corrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cluster</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a variety of second-level OLS models; all 1st-level models are standard OLS. By default will fit a model that makes parametric assumptions (under a t-distribution) replicating the output of software like R. 95% confidence intervals (CIs) are also estimated parametrically by default. However, empirical bootstrapping can also be used to compute CIs, which will resample with replacement from the first level regression estimates and uses these CIs to perform inference unless permutation tests are requested. Permutation testing  will perform a one-sample sign-flipped permutation test on the estimates directly (perm_on=&#39;mean&#39;) or the t-statistic (perm_on=&#39;t-stat&#39;). Permutation is a bit different than Lm which always permutes based on the t-stat.</span>

<span class="sd">        Alternatively, OLS robust to heteroscedasticity can be fit by computing sandwich standard error estimates (good ref: https://bit.ly/2VRb7jK). This is similar to Stata&#39;s robust routine.  </span>
<span class="sd">        Robust estimators include:</span>

<span class="sd">        - &#39;hc0&#39;: Huber (1980) original sandwich estimator</span>
<span class="sd">        </span>
<span class="sd">        - &#39;hc1&#39;: Hinkley (1977) DOF adjustment to &#39;hc0&#39; to account for small sample sizes (default)</span>

<span class="sd">        - &#39;hc2&#39;: different kind of small-sample adjustment of &#39;hc0&#39; by leverage values in hat matrix</span>

<span class="sd">        - &#39;hc3&#39;: MacKinnon and White (1985) HC3 sandwich estimator; provides more robustness in smaller samples than hc0, Long &amp; Ervin (2000)</span>

<span class="sd">        - &#39;hac&#39;: Newey-West (1987) estimator for robustness to heteroscedasticity as well as serial auto-correlation at given lags.</span>

<span class="sd">        - &#39;cluster&#39; : cluster-robust standard errors (see Cameron &amp; Miller 2015 for review). Provides robustness to errors that cluster according to specific groupings (e.g. repeated observations within a person/school/site). This acts as post-modeling &quot;correction&quot; for what a multi-level model explicitly estimates and is popular in the econometrics literature. DOF correction differs slightly from stat/statsmodels which use num_clusters - 1, where as pymer4 uses num_clusters - num_coefs</span>

<span class="sd">        Args:</span>
<span class="sd">            robust (bool/str): whether to use heteroscedasticity robust s.e. and optionally which estimator type to use (&#39;hc0&#39;,&#39;hc3&#39;,&#39;hac&#39;,&#39;cluster&#39;). If robust = True, default robust estimator is &#39;hc0&#39;; default False</span>
<span class="sd">            conf_int (str): whether confidence intervals should be computed through bootstrap (&#39;boot&#39;) or assuming a t-distribution (&#39;standard&#39;); default &#39;standard&#39;</span>
<span class="sd">            permute (int): if non-zero, computes parameter significance tests by permuting t-stastics rather than parametrically; works with robust estimators</span>
<span class="sd">            perm_on (str): permute based on a null distribution of the &#39;mean&#39; of first-level estimates or the &#39;t-stat&#39; of first-level estimates; default &#39;t-stat&#39;</span>
<span class="sd">            rank (bool): convert all predictors and dependent variable to ranks before estimating model; default False</span>
<span class="sd">            to_corrs (bool/string): for each first level model estimate a semi-partial or partial correlations instead of betas and perform inference over these partial correlation coefficients. *note* this is different than Lm(); default False</span>
<span class="sd">            ztrans_corrs (bool): whether to fisher-z transform (arcsin) first-level correlations before running second-level model. Ignored if to_corrs is False; default True</span>
<span class="sd">            summarize (bool): whether to print a model summary after fitting; default True</span>
<span class="sd">            verbose (bool): whether to print which model, standard error, confidence interval, and inference type are being fitted</span>
<span class="sd">            n_boot (int): how many bootstrap resamples to use for confidence intervals (ignored unless conf_int=&#39;boot&#39;)</span>
<span class="sd">            n_jobs (int): number of cores for parallelizing bootstrapping or permutations; default 1</span>
<span class="sd">            n_lags (int): number of lags for robust estimator type &#39;hac&#39; (ignored unless robust=&#39;hac&#39;); default 1</span>
<span class="sd">            cluster (str): column name identifying clusters/groups for robust estimator type &#39;cluster&#39; (ignored unless robust=&#39;cluster&#39;)</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame: R style summary() table</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">robust</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">robust</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">robust</span> <span class="o">=</span> <span class="s2">&quot;hc0&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">se_type</span> <span class="o">=</span> <span class="s2">&quot;robust&quot;</span> <span class="o">+</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="n">robust</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="k">if</span> <span class="n">cluster</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cluster</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;cluster identifier must be an existing column in data&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">se_type</span> <span class="o">=</span> <span class="s2">&quot;non-robust&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_type</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">conf_int</span> <span class="o">+</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_boot</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span> <span class="k">if</span> <span class="n">conf_int</span> <span class="o">==</span> <span class="s2">&quot;boot&quot;</span> <span class="k">else</span> <span class="n">conf_int</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_corrs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">to_corrs</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;semi&#39;</span><span class="p">,</span> <span class="s1">&#39;partial&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;to_corrs must be &#39;semi&#39; or &#39;partial&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">conf_int</span> <span class="o">==</span> <span class="s2">&quot;boot&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">permute</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span> <span class="o">=</span> <span class="s2">&quot;bootstrapped&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">permute</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">perm_on</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;t-stat&quot;</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;perm_on must be &#39;t-stat&#39; or &#39;mean&#39;&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span> <span class="o">=</span> <span class="s2">&quot;permutation&quot;</span> <span class="o">+</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">permute</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span> <span class="o">=</span> <span class="s2">&quot;parametric&quot;</span>

        <span class="c1"># Parallelize regression computation for 1st-level models</span>
        <span class="n">par_for</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;multiprocessing&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rank</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranked_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranked_data</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">to_corrs</span><span class="p">:</span>
            <span class="c1"># Loop over each group and get semi/partial correlation estimates</span>
            <span class="c1"># Reminder len(betas) == len(betas) - 1, from normal OLS, since corr of intercept is not computed</span>
            <span class="n">betas</span> <span class="o">=</span> <span class="n">par_for</span><span class="p">(</span>
                <span class="n">delayed</span><span class="p">(</span><span class="n">_corr_group</span><span class="p">)(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="n">i</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ranked_data</span><span class="p">,</span>
                    <span class="n">to_corrs</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">ztrans_corrs</span><span class="p">:</span>
                <span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctanh</span><span class="p">(</span><span class="n">betas</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">betas</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Loop over each group and fit a separate regression</span>
            <span class="n">betas</span> <span class="o">=</span> <span class="n">par_for</span><span class="p">(</span>
                <span class="n">delayed</span><span class="p">(</span><span class="n">_ols_group</span><span class="p">)(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="n">i</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ranked_data</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">betas</span><span class="p">)</span>

        <span class="c1"># Perform an intercept only regression for each beta</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">perm_ps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">betas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">betas</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]),</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">betas</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]})</span>
            <span class="n">lm</span> <span class="o">=</span> <span class="n">Lm</span><span class="p">(</span><span class="s2">&quot;Y ~ 1&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="n">robust</span><span class="o">=</span><span class="n">robust</span><span class="p">,</span>
                <span class="n">conf_int</span><span class="o">=</span><span class="n">conf_int</span><span class="p">,</span>
                <span class="n">summarize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">n_boot</span><span class="o">=</span><span class="n">n_boot</span><span class="p">,</span>
                <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
                <span class="n">n_lags</span><span class="o">=</span><span class="n">n_lags</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lm</span><span class="o">.</span><span class="n">coefs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">permute</span><span class="p">:</span>
                <span class="c1"># sign-flip permutation test for each beta instead to replace p-values</span>
                <span class="n">seeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">permute</span><span class="p">)</span>
                <span class="n">par_for</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;multiprocessing&quot;</span><span class="p">)</span>
                <span class="n">perm_est</span> <span class="o">=</span> <span class="n">par_for</span><span class="p">(</span>
                    <span class="n">delayed</span><span class="p">(</span><span class="n">_permute_sign</span><span class="p">)(</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">betas</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">seed</span><span class="o">=</span><span class="n">seeds</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">return_stat</span><span class="o">=</span><span class="n">perm_on</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">permute</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">perm_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">perm_est</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">perm_on</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
                    <span class="n">perm_ps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_perm_find</span><span class="p">(</span><span class="n">perm_est</span><span class="p">,</span> <span class="n">betas</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">perm_ps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_perm_find</span><span class="p">(</span><span class="n">perm_est</span><span class="p">,</span> <span class="n">lm</span><span class="o">.</span><span class="n">coefs</span><span class="p">[</span><span class="s2">&quot;T-stat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ivs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="n">ivs</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ivs</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">to_corrs</span><span class="p">:</span>
            <span class="n">intercept_pd</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">intercept_pd</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">intercept_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">intercept_pd</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">intercept_pd</span><span class="p">,</span> <span class="n">results</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ivs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span> <span class="o">=</span> <span class="n">results</span>
        <span class="k">if</span> <span class="n">to_corrs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">betas</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">ivs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">betas</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ivs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span>
        <span class="k">if</span> <span class="n">permute</span><span class="p">:</span>
            <span class="c1"># get signifance stars</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="p">[</span><span class="n">_sig_stars</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">perm_ps</span><span class="p">]</span>
            <span class="c1"># Replace dof and p-vales with permutation results</span>
            <span class="k">if</span> <span class="n">conf_int</span> <span class="o">!=</span> <span class="s2">&quot;boot&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DF&quot;</span><span class="p">,</span> <span class="s2">&quot;P-val&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">to_corrs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="p">[</span><span class="s2">&quot;Num_perm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">permute</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="p">[</span><span class="s2">&quot;Sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">+</span> <span class="n">sig</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="p">[</span><span class="s2">&quot;Perm-P-val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">+</span> <span class="n">perm_ps</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="p">[</span><span class="s2">&quot;Num_perm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">permute</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="p">[</span><span class="s2">&quot;Sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="p">[</span><span class="s2">&quot;Perm-P-val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">perm_ps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="p">[</span>
                <span class="p">[</span>
                    <span class="s2">&quot;Estimate&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;2.5_ci&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;97.5_ci&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;SE&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Num_perm&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;T-stat&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Perm-P-val&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Sig&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Need to figure out how best to compute predictions and residuals. Should test how Lmer does it, i.e. BLUPs or fixed effects?</span>
        <span class="c1"># Option 1) Use only second-level estimates</span>
        <span class="c1"># Option 2) Use only first-level estimates and make separate predictions per group</span>
        <span class="c1"># self.resid = res</span>
        <span class="c1"># self.data[&#39;fits&#39;] = y.squeeze() - res</span>
        <span class="c1"># self.data[&#39;residuals&#39;] = res</span>

        <span class="c1"># Fit statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsquared</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsquared</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsquared_adj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logLike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AIC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BIC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iscorrs</span> <span class="o">=</span> <span class="n">to_corrs</span>

        <span class="k">if</span> <span class="n">summarize</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summarize the output of a fitted model.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted to generate summary!&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Formula: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Family: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Std-errors: </span><span class="si">{}</span><span class="se">\t</span><span class="s2">CIs: </span><span class="si">{}</span><span class="s2"> 95%</span><span class="se">\t</span><span class="s2">Inference: </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">se_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig_type</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Number of observations: </span><span class="si">%s</span><span class="se">\t</span><span class="s2"> Groups: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()})</span>
        <span class="p">)</span>
        <span class="c1"># print(&quot;R^2: %.3f\t R^2_adj: %.3f\n&quot; %</span>
        <span class="c1">#       (self.data.shape[0], self.rsquared, self.rsquared_adj))</span>
        <span class="c1"># print(&quot;Log-likelihood: %.3f \t AIC: %.3f\t BIC: %.3f\n&quot; %</span>
        <span class="c1">#       (self.logLike, self.AIC, self.BIC))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fixed effects:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscorrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscorrs</span> <span class="o">==</span> <span class="s2">&quot;semi&quot;</span><span class="p">:</span>
                <span class="n">corr</span> <span class="o">=</span> <span class="s2">&quot;semi-partial&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscorrs</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Note: </span><span class="si">{}</span><span class="s2"> correlations reported&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">corr</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="n">error_bars</span><span class="o">=</span><span class="s2">&quot;ci&quot;</span><span class="p">,</span>
        <span class="n">ranef</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">axlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ranef_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">coef_fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
        <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;v&#39;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a forestplot overlaying estimated coefficients with first-level effects. By default display the 95% confidence intervals computed during fitting.</span>

<span class="sd">        Args:</span>
<span class="sd">            error_bars (str): one of &#39;ci&#39; or &#39;se&#39; to change which error bars are plotted; default &#39;ci&#39;</span>
<span class="sd">            ranef (bool): overlay BLUP estimates on figure; default True</span>
<span class="sd">            axlim (tuple): lower and upper limit of plot; default min and max of BLUPs</span>
<span class="sd">            ranef_alpha (float): opacity of random effect points; default .5</span>
<span class="sd">            coef_fmt (str): matplotlib marker style for population coefficients</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib axis handle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model must be fit before plotting!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orient</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;orientation must be &#39;h&#39; or &#39;v&#39;&quot;</span><span class="p">)</span>

        <span class="n">m_ranef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixef</span>
        <span class="n">m_fixef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">error_bars</span> <span class="o">==</span> <span class="s2">&quot;ci&quot;</span><span class="p">:</span>
            <span class="n">col_lb</span> <span class="o">=</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;2.5_ci&quot;</span><span class="p">]</span>
            <span class="n">col_ub</span> <span class="o">=</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;97.5_ci&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">error_bars</span> <span class="o">==</span> <span class="s2">&quot;se&quot;</span><span class="p">:</span>
            <span class="n">col_lb</span><span class="p">,</span> <span class="n">col_ub</span> <span class="o">=</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;SE&quot;</span><span class="p">],</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s2">&quot;SE&quot;</span><span class="p">]</span>

        <span class="c1"># For seaborn</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">m_ranef</span><span class="p">)</span>

        <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ranef</span><span class="p">:</span>
            <span class="n">alpha_plot</span> <span class="o">=</span> <span class="n">ranef_alpha</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alpha_plot</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">orient</span> <span class="o">==</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span>
            <span class="n">x_strip</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span>
            <span class="n">x_err</span> <span class="o">=</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s1">&#39;Estimate&#39;</span><span class="p">]</span>
            <span class="n">y_strip</span> <span class="o">=</span> <span class="s1">&#39;variable&#39;</span>
            <span class="n">y_err</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">m_fixef</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_lb</span><span class="p">,</span> <span class="n">col_ub</span><span class="p">]</span>
            <span class="n">yerr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyles</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">axlim</span><span class="p">:</span>
                <span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xlim</span> <span class="o">=</span> <span class="n">axlim</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_strip</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span>
            <span class="n">y_err</span> <span class="o">=</span> <span class="n">m_fixef</span><span class="p">[</span><span class="s1">&#39;Estimate&#39;</span><span class="p">]</span>
            <span class="n">x_strip</span> <span class="o">=</span> <span class="s1">&#39;variable&#39;</span>
            <span class="n">x_err</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">m_fixef</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">yerr</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_lb</span><span class="p">,</span> <span class="n">col_ub</span><span class="p">]</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyles</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">axlim</span><span class="p">:</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="n">axlim</span>
            <span class="n">xlim</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_strip</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y_strip</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_plot</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span>
        <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_err</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y_err</span><span class="p">,</span>
            <span class="n">xerr</span><span class="o">=</span><span class="n">xerr</span><span class="p">,</span>
            <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="n">coef_fmt</span><span class="p">,</span>
            <span class="n">capsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">elinewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">ms</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">9999999999</span><span class="p">,</span>
        <span class="p">)</span>
       
        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span>
</pre></div>

          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2017, Eshin Jolly.
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.0 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a>.
</div>
            </div>
          </div>
      </page>
  </div></body>
</html>